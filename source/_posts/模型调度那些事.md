---
title: 模型调度那些事儿
date: 2019-05-18 16:31:42
categories: Technical Innovation
tags:
     - airflow
---


# 关于模型调度的那些事儿

## 模型调度
目前公司采用airflow作为调度平台，调度中目前分为数仓任务调度、模型任务调度和后端任务调度。为了提高大家对任务调度的理解，这里对模型的调度工作做下详细说明。

模型整体的调度从顺序上可以分为串行调度或并行调度或混合调度。画个图解释一下：




```
graph LR
A-->B
B-->C
C-->D
A-->E
E-->F
F-->D
```
<center>混合调度图</center></br>


从资源占用上可以分为单机调度或多机调度。
画个图解释一下：

```
graph LR
id((client)) --ssh command--> worker_A
id((client)) --ssh command--> worker_B
id((client)) --ssh command--> worker_C

```

<center>多机调度图</center>


## 模型备份与回滚
### 模型调度备份
为了确保模型的稳定性，针对模型需要设置备选调度路径。




```
graph LR

id((model_ra)) --1:if success--> next_task
id((model_ra)) --2: retry--> id((model_ra))
id((model_ra)) --3:if fail--> model_ra_bak
model_ra_bak --4:if fail--> email
model_ra_bak --4:if success--> next_task
```

<center>模型调度备份路径图</center>



</br>

### 模型线上回滚
当最近两个版本的模型均不能正常工作，可以联系运维，申请线上版本回退。

目前，线上运维备份机制主要是通过软链接的形式进行更新与备份，可以通过更改软连接的指向地址来回滚线上版本。举个例子：


``` 
graph TD
subgraph bak  
model_ra_0811 --- model_ra_0812
model_ra_0812 --- model_ra_0813
end

subgraph product
model_ra --> model_ra_0813

end
```
<center>正常状态</center></br>

```
graph BT
subgraph bak  
model_ra_0811 --- model_ra_0812
model_ra_0812 --- model_ra_0813
end

subgraph product
model_ra --> model_ra_0811

end
```
<center>回滚后状态</center>


### 模型表备份
模型通常都是以输出结果表的形式来和数仓任务进行交互。初始交互方式如下图所示：


```
graph LR
subgraph model_task  
model_ra --> mod_sku_replenish
model_ra --> mod_sku_allot


end

subgraph warehouse_task
mod_sku_replenish --> DM_task
mod_sku_allot --> DM_task
end
```
<center>模型表备份方案1</center></br>

经过一段时间的实践，发现上图中的交互方式存在以下问题：
1. 模型创建的表，数仓无权限读取和写入
1. 模型无法重试，无法重复写库，模型写入的数据不能直接覆盖，要有留存。
1. 数仓需要对模型输出表做些转换。
1. 可能会存在误删情况，因为建模测试表非常多
1. 无法处理多品牌的写库问题，无法同时看到两份数据


为了解决以上问题，总结出以下方案：
```
graph LR
subgraph model_task  
model_ra --> mod_sku_replenish_current
model_ra --> mod_sku_allot_current
end

subgraph warehouse_task
mod_sku_replenish_current --> mod_sku_replenish
mod_sku_allot_current --> mod_sku_allot
mod_sku_replenish --> DM_tasks
mod_sku_allot --> DM_tasks
end
```
<center>模型表备份方案2</center>

另外，如果采用分区表的形式去做模型表备份，仍然存在两个问题：
1：模型的输出是不确定性的，经常需要删除重建
2：数据分析师在线上进行模型输出单据快速验证时，需要在不覆盖凌晨的自动调度生成的表的前提下进行输出补调单
3：模型和建模同时操作一张表，极易导致表的数据损坏和误删除。


## 模型测试调度线
为了对模型的效果进行快速验证，数据分析师或者项目经理需要基于最新的数据生成补调单据，进行模型结果分析。

为了不影响生产环境中的调度，算法组总结出了模型测试调度线机制，专门用来进行模型的测试验证。这里提一下，模型测试调度线，并不是只能测试一个模型，可以包含多个模型。


测试调度线的使用流程如下：
- 建模本地测试通过，项目经理和建模初步确认结果，例如总调拨量，总捕获量等。
- 建模提交代码给算法，由算法测试通过后，上传至模型测试调度线的模型代码目录，并修改相应参数(如写测试表等)，交由数据分析师或者项目经理进行调度。
- 模型测试通过后，即可执行整个测试调度脚本，当执行完后续的数仓处理存储过程和导出存储过程，即可通过邮件将导出的单据直接发送到数据分析师或者项目经理邮箱。
- 项目经理和数据分析师可以基于收到的单据和数据库中的模型结果表进行详细分析，输出模型效果评价。
- 项目经理确定是否更新线上模型。

#### 模型测试调度线的示意图如下图所示：
```
graph LR
id(start) --> model_ra
model_ra --> dm_task
dm_task --> rst_task
rst_task --> generate_documents
generate_documents --> email_documents
email_documents --> success_email
```
<center>模型测试调度线</center>























